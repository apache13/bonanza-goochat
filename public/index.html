<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
		<title>GooChat Beta</title>
	</head>
	<body>

		<h1>GooChat Beta</h1>
		<div>
			<h2>Announcement</h2>
			<ul>
				<li>
					Press <strong>Enter</strong> to send message
				</li>
				<li>
					Cannot send empty message
				</li>
			</ul>
		</div>

		<div id="schedule">
			<table border="1">
				<caption>
					DJ Schedule
				</caption>
				<tr>
					<th>Time/Date</th>
					<th>Mon</th>
					<th>Tue</th>
					<th>Wed</th>
					<th>Thu</th>
					<th>Fri</th>
					
				</tr>
				<tr>
					<th>8:00-12.00</th>
					<td>DJ Beer</td>
					<td>DJ Poy</td>
					<td>DJ Beer</td>
					<td>DJ Poy</td>
					<td>DJ Beer</td>
				</tr>
				<tr>
					<th>13:00-17.00</th>
					<td>DJ Poy</td>
					<td>DJ Beer</td>
					<td>DJ Poy</td>
					<td>DJ Beer</td>
					<td>DJ Poy</td>
				</tr>
			</table>
		</div>

		<h2>Wealth Station</h2>
		<div id="radio">
			<div id="player">
				<audio controls="controls" height="100" width="100" autoplay="true">
					<source src="http://localhost:8000" type="audio/mp3">
					<embed height="100" width="100" src="http://localhost:8000">
				</audio>
			</div>
			<span>คุณกำลังฟัง : </span><span id="currentSong">loading ...</span>
		</div>

		<h2>Profile</h2>
		<div class="pref">
			Change name to:
			<input type="text" id="nameChangeTxt" />
			<button id="nameChangeBtn">
				Change
			</button>
		</div>

		<h2>Chat Log</h2>

		<div id="chatLogPane" style="width:500px;height:300px;overflow-y:scroll;background:gainsboro;float:left;">
			<ul id="chatLog" style="padding-left: 5px; list-style-type: none"></ul>
		</div>
		<div id="userListPane" style="width:200px;height:300px;overflow-y:scroll;float:left;">
			<ul id="userList" style="list-style-type: none;padding-left: 5px;"></ul>
		</div>

		<div class="chatActions" style="clear: both">
			<span id="name" style="font-weight:bold;">?</span>
			<input type="text" id="sayText" style="width: 200px" />
			<button id="sayBtn">
				Send
			</button>
		</div>

		<script src="/socket.io/socket.io.js"></script>
		<script src="/javascripts/jquery-1.8.1.min.js"></script>

		<script>
			var socket = io.connect();
			var id;
			socket.on('id', onId);
			socket.on('syn', onSyn);
			socket.on('pushMsg', onPushMsg);
			socket.on('changeIdResult', onChangeIdResult);
			socket.on('idChanged', onIdChanged);

			function onId(data) {
				id = data.id;
				$('#name').html(data.id);
				$('#userList').append('<li><strong>' + data.id + '</strong></li>');
			}

			function onPushMsg(data) {
				$('#chatLog').append('<li><span style="font-size:smaller">' + data.timestamp + '</span>&nbsp<strong>' + data.id + '</strong>&nbsp:&nbsp<span>' + data.msg + '</span></li>');
				$("#chatLogPane").scrollTop($("#chatLog")[0].scrollHeight);
			}

			function onChangeIdResult(data) {
				if (data.success) {
					id = data.newId;
					onId({
						'id' : id
					});
					return;
				}
				alert('Name already in used.');
			}

			function onIdChanged(data) {
				$('#chatLog').append('<li><strong>' + data.oldId + '</strong> has changed name to: ' + data.newId + '</li>');
			}

			function onSyn(data) {
				ack();
				
				$('#userList').children().remove();
				var userIds = data['userIds'];
				for (var userId in userIds) {
					$('#userList').append('<li><strong>' + userId + '</strong></li>');
				}
				
				var currentSong = data['currentSong'];
				if(currentSong['_OK']){
					$('#currentSong').html(currentSong['Artist']+'-'+currentSong['Title']);
				}
				
			}

			function ack() {
				socket.emit('ack', {
					'id' : id
				});
			}

			/*----------------------------*/

			$('#sayBtn').click(emitMsg);
			var $sayText = $('#sayText').keyup(function(e) {
				if (e.keyCode === 13) {
					emitMsg();
				}
			});
			function emitMsg() {
				var msg = $sayText.val();
				if (!!msg == false) {
					alert('Enter your message!!');
					return;
				}
				socket.emit('msg', {
					'msg' : msg,
					'id' : id
				});
				$sayText.val('');
			}


			$('#nameChangeBtn').click(function() {
				var newId = $('#nameChangeTxt').val();
				if (!!newId == false) {
					alert('Enter your new name!!');
					return;
				}
				socket.emit('changeId', {
					'oldId' : id,
					'newId' : newId
				});
				$('#nameChangeTxt').val('');
			});

		</script>

	</body>
</html>

