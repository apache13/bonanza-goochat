<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
		<title>GooChat Beta</title>
	</head>
	<body>

		<h1>GooChat Beta</h1>
		<div>
			<h2>Announcement</h2>
			<ul>
				<li>
					Press <strong>Enter</strong> to send message
				</li>
				<li>
					Cannot send empty message
				</li>
			</ul>
		</div>

		<h2>Wealth Station</h2>
		<div id="radio">
			<div id="player">
				<embed height="80" width="300" src="http://nuttapon-i3:8000" autoplay="false" controller="true">
			</div>
			<span id="playerInfo">n/a</span>
			<div id="schedule">
				<table border="1">
					<caption>
						DJ Schedule
					</caption>
					<tr>
						<th></th>
						<th>8:00-12:00</th>
						<th>13:00-17:00</th>
					</tr>
					<tr>
						<td>Mon</td>
						<td>DJ Beer</td>
						<td>DJ Poy</td>
					</tr>
					<tr>
						<td>Tue</td>
						<td>DJ Poy</td>
						<td>DJ Beer</td>
					</tr>
					<tr>
						<td>Web</td>
						<td>DJ Beer</td>
						<td>DJ Poy</td>
					</tr>
					<tr>
						<td>Thu</td>
						<td>DJ Beer</td>
						<td>DJ Poy</td>
					</tr>
					<tr>
						<td>Fri</td>
						<td>DJ Poy</td>
						<td>DJ Beer</td>
					</tr>
				</table>
			</div>
		</div>

		<h2>Profile</h2>
		<div class="pref">
			Change name to:
			<input type="text" id="nameChangeTxt" />
			<button id="nameChangeBtn">
				Change
			</button>
		</div>

		<h2>Chat Log</h2>

		<div id="chatLogPane" style="width:500px;height:300px;overflow-y:scroll;background:gainsboro;float:left;">
			<ul id="chatLog" style="padding-left: 5px; list-style-type: none"></ul>
		</div>
		<div id="userListPane" style="width:200px;height:300px;overflow-y:scroll;float:left;">
			<ul id="userList"></ul>
		</div>

		<div class="chatActions" style="clear: both">
			<span id="name">?</span>
			<input type="text" id="sayText" style="width: 200px" />
			<button id="sayBtn">
				Send
			</button>
		</div>

		<script src="/socket.io/socket.io.js"></script>
		<script src="/javascripts/jquery-1.8.1.min.js"></script>

		<script>
			var socket = io.connect();
			var id;
			socket.on('id', onId);
			socket.on('syn', onSyn);
			socket.on('pushMsg', onPushMsg);
			socket.on('changeIdResult', onChangeIdResult);
			socket.on('idChanged', onIdChanged);

			function onId(data) {
				id = data.id;
				$('#name').html(data.id);
				$('#userList').append('<li><strong>' + data.id + '</strong></li>');
			}

			function onPushMsg(data) {
				$('#chatLog').append('<li><strong>' + data.id + '</strong> : ' + data.msg + '</li>');
				$("#chatLogPane").scrollTop($("#chatLog")[0].scrollHeight);
			}

			function onChangeIdResult(data) {
				if (data.success) {
					id = data.newId;
					onId({
						'id' : id
					});
					return;
				}
				alert('Name already in used.');
			}

			function onIdChanged(data) {
				$('#chatLog').append('<li><strong>' + data.oldId + '</strong> has changed name to: ' + data.newId + '</li>');
			}

			function onSyn(data) {
				ack();
				$('#userList').children().remove();
				var userIds = data['userIds'];
				for (var userId in userIds) {
					$('#userList').append('<li><strong>' + userId + '</strong></li>');
				}
				
			}

			function ack(){
				socket.emit('ack', {'id':id});
			}
			/*----------------------------*/

			$('#sayBtn').click(emitMsg);
			var $sayText = $('#sayText').keyup(function(e) {
				if (e.keyCode === 13) {
					emitMsg();
				}
			});
			function emitMsg() {
				var msg = $sayText.val();
				if (!!msg == false) {
					alert('Enter your message!!');
					return;
				}
				socket.emit('msg', {
					'msg' : msg,
					'id' : id
				});
				$sayText.val('');
			}


			$('#nameChangeBtn').click(function() {
				var newId = $('#nameChangeTxt').val();
				if (!!newId == false) {
					alert('Enter your new name!!');
					return;
				}
				socket.emit('changeId', {
					'oldId' : id,
					'newId' : newId
				});
			});

		</script>

	</body>
</html>

